name: "Run TODO to Issue"

on:
  push:
  workflow_dispatch:
    inputs:
      MANUAL_COMMIT_REF:
        description: "The SHA of the commit to get the diff for"
        required: true
      MANUAL_BASE_REF:
        description: "By default, the commit entered above is compared to the one directly before it; to go back further, enter an earlier SHA here"
        required: false

jobs:
  build:
    runs-on: "ubuntu-latest"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Commit SHAs
        id: commits
        run: |
          if git rev-parse ${{ github.event.inputs.MANUAL_BASE_REF || 'HEAD~1' }} >/dev/null 2>&1; then
            echo "base_ref=${{ github.event.inputs.MANUAL_BASE_REF || 'HEAD~1' }}" >> $GITHUB_ENV
          else
            echo "base_ref=$(git rev-list --max-parents=0 HEAD)" >> $GITHUB_ENV
          fi
          echo "commit_ref=${{ github.event.inputs.MANUAL_COMMIT_REF || 'HEAD' }}" >> $GITHUB_ENV

      - name: Debug File Changes
        run: |
          echo "Changed files:"
          git diff --name-only $base_ref $commit_ref

      - name: "TODO to Issue"
        uses: "alstr/todo-to-issue-action@v5"
        with:
          INSERT_ISSUE_URLS: "true"
          PROJECT: "user/lonesume/shmood"
          PROJECTS_SECRET: "${{ secrets.PROJECTS_SECRET }}"
          COMMIT_REF: $commit_ref
          BASE_REF: $base_ref
